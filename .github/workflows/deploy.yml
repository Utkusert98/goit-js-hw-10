name: Build and deploy to Main Branch Root

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2.3.1
        with:
          # Tüm geçmişi getir, bu daha sonra force push için gerekebilir
          fetch-depth: 0

      - name: Setup Node.js 🚀 # Node.js'in belirli bir sürümünü kurar
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Vite projeniz için uygun Node.js sürümünü buraya yazın (örneğin '18', '20')

      - name: Install and build 🔧
        run: |
          npm install
          # Vite yürütülebilir dosyasına çalıştırma izni ver (önceki hatayı önlemek için)
          chmod +x node_modules/.bin/vite || true
          npm run build

      - name: Deploy to Main Branch Root 🚀
        run: |
          # Git kullanıcı bilgilerini yapılandır
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Geçici bir dizin oluştur ve derlenmiş dosyaları buraya kopyala
          mkdir deploy_temp
          cp -r dist/* deploy_temp/

          # Geçici dizine git
          cd deploy_temp

          # Yeni bir Git deposu başlat
          git init

          # Tüm dosyaları ekle ve commit et
          git add .
          git commit -m "Deploy built files to main branch"

          # Uzak depoyu (kendi deponuzu) ekle
          # GITHUB_TOKEN, GitHub Actions tarafından otomatik olarak sağlanan bir belirteçtir
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

          # main dalına zorla push et
          # DİKKAT: Bu komut, main dalının mevcut içeriğini deploy_temp'in içeriğiyle tamamen değiştirecektir.
          git push --force origin main
